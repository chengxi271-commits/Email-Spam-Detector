<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹æ•ˆæœå¯¹æ¯”åˆ†æå™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="main-container">
        <header class="app-header">
            <h1>æ¨¡å‹æ•ˆæœå¯¹æ¯”åˆ†æå™¨</h1>
            <p class="subtitle">æ ‡å‡†BERT vs. å­—å½¢æ‹¼éŸ³å¢å¼ºBERT</p>
        </header>

        <main class="content-view" id="main-content">
            <div id="welcome-message">
                <p>åœ¨ä¸‹æ–¹è¾“å…¥æ–‡æœ¬è¿›è¡Œå•æ¡åˆ†æï¼Œæˆ–ç‚¹å‡»â€œğŸ“Šâ€æŒ‰é’®æŸ¥çœ‹å·²ç”Ÿæˆçš„å®Œæ•´è¯„æµ‹æŠ¥å‘Šã€‚</p>
            </div>
            <div id="result-container"></div>
        </main>

        <footer class="input-area">
            <button id="show-report-button" title="å±•ç¤ºå·²ç”Ÿæˆçš„å®Œæ•´è¯„æµ‹æŠ¥å‘Š">ğŸ“Š æ˜¾ç¤ºæŠ¥å‘Š</button>
            <textarea id="text-input" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¦åˆ†æçš„æ–‡æœ¬..." rows="1"></textarea>
            <button id="submit-button" title="åˆ†æ (Ctrl+Enter)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path
                        d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z" />
                </svg>
            </button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // è·å–å…ƒç´ 
            const submitButton = document.getElementById('submit-button');
            const showReportButton = document.getElementById('show-report-button');
            const textInput = document.getElementById('text-input');
            const resultContainer = document.getElementById('result-container');
            const welcomeMessage = document.getElementById('welcome-message');

            // å•æ¡é¢„æµ‹é€»è¾‘
            const handleSingleSubmit = function () {
                const text = textInput.value;
                if (!text.trim()) return;

                welcomeMessage.style.display = 'none';
                resultContainer.innerHTML = '<p class="loading">æ­£åœ¨è¯·æ±‚ä¸¤ä¸ªæ¨¡å‹è¿›è¡Œåˆ†æ...</p>';
                textInput.value = '';

                fetch('/predict_comparison', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                })
                    .then(response => response.json())
                    .then(data => {
                        let resultHTML = `
                        <div class="comparison-grid">
                            <div class="result-card">
                                <h3>æ ‡å‡† BERT</h3>
                                <div class="verdict ${data.model_a_result.is_spam ? 'spam' : 'ham'}">${data.model_a_result.is_spam ? 'åˆ¤å®šä¸º: åƒåœ¾é‚®ä»¶' : 'åˆ¤å®šä¸º: æ­£å¸¸é‚®ä»¶'}</div>
                                <p>ç½®ä¿¡åº¦: <strong>${data.model_a_result.is_spam ? data.model_a_result.confidence.spam : data.model_a_result.confidence.ham}</strong></p>
                            </div>
                            <div class="result-card">
                                <h3>å¢å¼ºç‰ˆ ChineseBERT</h3>
                                <div class="verdict ${data.model_b_result.is_spam ? 'spam' : 'ham'}">${data.model_b_result.is_spam ? 'åˆ¤å®šä¸º: åƒåœ¾é‚®ä»¶' : 'åˆ¤å®šä¸º: æ­£å¸¸é‚®ä»¶'}</div>
                                <p>ç½®ä¿¡åº¦: <strong>${data.model_b_result.is_spam ? data.model_b_result.confidence.spam : data.model_b_result.confidence.ham}</strong></p>
                            </div>
                        </div>
                    `;
                        resultContainer.innerHTML = resultHTML;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        resultContainer.innerHTML = '<p class="error">åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</p>';
                    });
            };

            // å±•ç¤ºå®Œæ•´è¯„æµ‹æŠ¥å‘Šçš„é€»è¾‘
            const showFullReport = async function () {
                welcomeMessage.style.display = 'none';
                resultContainer.innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½è¯„æµ‹æŠ¥å‘Š...</p>';

                try {
                    const response = await fetch('/get_evaluation_report');
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || `æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                    }
                    const report = await response.json();

                    const buildReportCard = (reportData) => {
                        const cm = reportData.confusion_matrix;
                        return `
                            <div class="evaluation-report">
                                <h3>${reportData.model_name}</h3>
                                <div class="metrics-grid">
                                    <div class="metric-card"><h4>å‡†ç¡®ç‡</h4><p>${reportData.accuracy}</p></div>
                                    <div class="metric-card"><h4>ç²¾ç¡®ç‡</h4><p>${reportData.precision}</p></div>
                                    <div class="metric-card"><h4>å¬å›ç‡</h4><p>${reportData.recall}</p></div>
                                    <div class="metric-card"><h4>F1åˆ†æ•°</h4><p>${reportData.f1_score}</p></div>
                                </div>
                                <h4>æ··æ·†çŸ©é˜µ (å…± ${reportData.total_samples} æ¡)</h4>
                                <table class="confusion-matrix">
                                    <tr><td></td><td>é¢„æµ‹ä¸ºæ­£å¸¸</td><td>é¢„æµ‹ä¸ºåƒåœ¾</td></tr>
                                    <tr><td>å®é™…ä¸ºæ­£å¸¸</td><td>${cm.true_negatives} (TN)</td><td>${cm.false_positives} (FP)</td></tr>
                                    <tr><td>å®é™…ä¸ºåƒåœ¾</td><td>${cm.false_negatives} (FN)</td><td>${cm.true_positives} (TP)</td></tr>
                                </table>
                            </div>
                        `;
                    };

                    let reportHTML = `
                        <h2>æµ‹è¯•é›†å®Œæ•´è¯„ä¼°æŠ¥å‘Š</h2>
                        <div class="comparison-grid">
                            ${buildReportCard(report.model_a_report)}
                            ${buildReportCard(report.model_b_report)}
                        </div>
                    `;
                    resultContainer.innerHTML = reportHTML;
                } catch (error) {
                    console.error("Failed to show report:", error);
                    resultContainer.innerHTML = `<p class="error">åŠ è½½æŠ¥å‘Šå¤±è´¥: ${error.message}</p>`;
                }
            };

            // ç»‘å®šäº‹ä»¶
            submitButton.addEventListener('click', handleSingleSubmit);
            showReportButton.addEventListener('click', showFullReport);

            textInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
                    event.preventDefault();
                    handleSingleSubmit();
                }
            });
        });
    </script>
</body>

</html>